{% extends "admin_base.html" %}
{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">
<style>
    .advanced-dashboard {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
    .big-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }
    @media (max-width: 1200px) {
        .big-stats { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
        .big-stats { grid-template-columns: 1fr; }
    }
    
    .big-stat-card {
        background: linear-gradient(135deg, var(--card), var(--card-hover));
        border-radius: 20px;
        padding: 25px;
        position: relative;
        overflow: hidden;
    }
    .big-stat-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
    }
    .big-stat-card .icon {
        font-size: 40px;
        margin-bottom: 15px;
    }
    .big-stat-card .value {
        font-size: 36px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .big-stat-card .label {
        color: var(--muted);
        font-size: 14px;
    }
    .big-stat-card .change {
        position: absolute;
        top: 20px;
        left: 20px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }
    .big-stat-card .change.up {
        background: rgba(0,184,148,0.2);
        color: var(--success);
    }
    .big-stat-card .change.down {
        background: rgba(231,76,60,0.2);
        color: var(--danger);
    }
    
    /* Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
    .charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
    }
    @media (max-width: 1000px) {
        .charts-grid { grid-template-columns: 1fr; }
    }
    
    .chart-card {
        background: var(--card);
        border-radius: 20px;
        padding: 25px;
    }
    .chart-card h3 {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… */
    .customers-section {
        background: var(--card);
        border-radius: 20px;
        overflow: hidden;
    }
    .section-header {
        padding: 20px 25px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    .section-header h3 {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
    }
    .filter-tabs {
        display: flex;
        gap: 10px;
    }
    .filter-tab {
        padding: 8px 16px;
        border-radius: 20px;
        border: none;
        background: rgba(255,255,255,0.1);
        color: var(--muted);
        cursor: pointer;
        transition: all 0.3s;
        font-family: 'Tajawal', sans-serif;
    }
    .filter-tab.active {
        background: var(--primary);
        color: white;
    }
    
    .customer-row {
        display: grid;
        grid-template-columns: 50px 2fr 1fr 1fr 1fr 1fr 100px;
        align-items: center;
        padding: 15px 25px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        transition: background 0.2s;
    }
    .customer-row:hover {
        background: rgba(255,255,255,0.03);
    }
    .customer-row.header {
        background: rgba(0,0,0,0.2);
        font-weight: bold;
        color: var(--muted);
        font-size: 13px;
    }
    @media (max-width: 900px) {
        .customer-row {
            grid-template-columns: 40px 2fr 1fr 80px;
        }
        .customer-row > *:nth-child(4),
        .customer-row > *:nth-child(5),
        .customer-row > *:nth-child(6) {
            display: none;
        }
    }
    
    .customer-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), #8b7cf7);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
    }
    .customer-info h4 {
        margin: 0 0 3px 0;
        font-size: 15px;
    }
    .customer-info p {
        margin: 0;
        font-size: 12px;
        color: var(--muted);
    }
    .customer-phone {
        font-family: 'Courier New', monospace;
        font-size: 13px;
        direction: ltr;
        color: var(--success);
    }
    .customer-phone.no-phone {
        color: var(--muted);
        font-style: italic;
    }
    
    .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: bold;
    }
    .badge-success { background: rgba(0,184,148,0.2); color: var(--success); }
    .badge-warning { background: rgba(243,156,18,0.2); color: var(--warning); }
    .badge-danger { background: rgba(231,76,60,0.2); color: var(--danger); }
    .badge-primary { background: rgba(108,92,231,0.2); color: var(--primary-light); }
    
    .action-btn {
        padding: 8px 15px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-family: 'Tajawal', sans-serif;
        font-size: 13px;
        transition: all 0.2s;
    }
    .action-btn.view {
        background: var(--primary);
        color: white;
    }
    .action-btn:hover {
        transform: scale(1.05);
    }
    
    /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… */
    .advanced-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        z-index: 3000;
        overflow-y: auto;
        padding: 20px;
    }
    .modal-container {
        max-width: 900px;
        margin: 0 auto;
        background: var(--bg);
        border-radius: 25px;
        overflow: hidden;
    }
    .modal-header-big {
        background: linear-gradient(135deg, var(--primary), #a29bfe);
        padding: 30px;
        position: relative;
    }
    .modal-close-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0,0,0,0.3);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
    }
    .customer-profile {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    .customer-profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
    }
    .customer-profile-info h2 {
        margin: 0 0 5px 0;
        font-size: 24px;
    }
    .customer-profile-info p {
        margin: 0;
        opacity: 0.8;
    }
    
    .modal-body {
        padding: 30px;
    }
    .modal-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 30px;
    }
    @media (max-width: 600px) {
        .modal-stats { grid-template-columns: repeat(2, 1fr); }
    }
    .modal-stat {
        background: var(--card);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
    }
    .modal-stat .value {
        font-size: 28px;
        font-weight: bold;
        color: var(--primary-light);
    }
    .modal-stat .label {
        font-size: 12px;
        color: var(--muted);
        margin-top: 5px;
    }
    
    .tabs-container {
        margin-bottom: 20px;
    }
    .tabs {
        display: flex;
        gap: 10px;
        border-bottom: 2px solid rgba(255,255,255,0.1);
        padding-bottom: 15px;
    }
    .tab-btn {
        padding: 10px 20px;
        border: none;
        background: none;
        color: var(--muted);
        cursor: pointer;
        font-family: 'Tajawal', sans-serif;
        font-size: 14px;
        border-radius: 10px;
        transition: all 0.2s;
    }
    .tab-btn.active {
        background: var(--primary);
        color: white;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    
    .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: var(--card);
        border-radius: 12px;
        margin-bottom: 10px;
    }
    .history-item .info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .history-item .icon-box {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }
    .history-item .icon-box.charge { background: rgba(0,184,148,0.2); }
    .history-item .icon-box.purchase { background: rgba(231,76,60,0.2); }
    .history-item .icon-box.invoice { background: rgba(108,92,231,0.2); }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--muted);
    }
    .empty-state .icon {
        font-size: 50px;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="top-bar">
    <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h1>
    <div class="top-bar-actions">
        <button class="btn btn-secondary btn-sm" onclick="loadDashboard()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <button class="btn btn-primary btn-sm" onclick="exportData()">ğŸ“¥ ØªØµØ¯ÙŠØ±</button>
    </div>
</div>

<!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© -->
<div class="big-stats">
    <div class="big-stat-card">
        <div class="icon">ğŸ‘¥</div>
        <div class="value" id="totalCustomers">0</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="change up" id="customersChange">â†‘ 0%</div>
    </div>
    <div class="big-stat-card">
        <div class="icon">ğŸ“±</div>
        <div class="value" id="verifiedPhones">0</div>
        <div class="label">Ø£Ø±Ù‚Ø§Ù… Ù…ÙˆØ«Ù‚Ø©</div>
        <div class="change up" id="phonesChange">â†‘ 0%</div>
    </div>
    <div class="big-stat-card">
        <div class="icon">ğŸ§¾</div>
        <div class="value" id="totalInvoices">0</div>
        <div class="label">Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ù†Ø´Ø£Ø©</div>
        <div class="change up" id="invoicesChange">â†‘ 0%</div>
    </div>
    <div class="big-stat-card">
        <div class="icon">ğŸ’°</div>
        <div class="value" id="totalRevenue">0</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø±.Ø³)</div>
        <div class="change up" id="revenueChange">â†‘ 0%</div>
    </div>
</div>

<!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
<div class="charts-grid">
    <div class="chart-card">
        <h3>ğŸ“ˆ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h3>
        <div class="chart-container">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
    <div class="chart-card">
        <h3>ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
        <div class="chart-container">
            <canvas id="customersChart"></canvas>
        </div>
    </div>
</div>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
<div class="customers-section">
    <div class="section-header">
        <h3>ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <input type="text" id="searchCustomers" placeholder="ğŸ” Ø¨Ø­Ø«..." 
                   style="padding: 10px 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.2); color: white; width: 200px;">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterCustomers('all')">Ø§Ù„ÙƒÙ„</button>
                <button class="filter-tab" onclick="filterCustomers('verified')">Ù…ÙˆØ«Ù‚ÙŠÙ†</button>
                <button class="filter-tab" onclick="filterCustomers('active')">Ù†Ø´Ø·ÙŠÙ†</button>
            </div>
        </div>
    </div>
    
    <div class="customer-row header">
        <div>#</div>
        <div>Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
        <div>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</div>
        <div>Ø§Ù„Ø±ØµÙŠØ¯</div>
        <div>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
        <div>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·</div>
        <div>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</div>
    </div>
    
    <div id="customersList">
        <div style="text-align: center; padding: 40px;">
            <div class="spinner" style="margin: 0 auto;"></div>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
<div class="advanced-modal" id="customerModal">
    <div class="modal-container">
        <div class="modal-header-big">
            <button class="modal-close-btn" onclick="closeCustomerModal()">âœ•</button>
            <div class="customer-profile">
                <div class="customer-profile-avatar" id="modalAvatar">ğŸ‘¤</div>
                <div class="customer-profile-info">
                    <h2 id="modalName">-</h2>
                    <p id="modalId">ID: -</p>
                </div>
            </div>
        </div>
        
        <div class="modal-body">
            <div class="modal-stats">
                <div class="modal-stat">
                    <div class="value" id="modalBalance">0</div>
                    <div class="label">ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯</div>
                </div>
                <div class="modal-stat">
                    <div class="value" id="modalInvoices">0</div>
                    <div class="label">ğŸ§¾ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
                </div>
                <div class="modal-stat">
                    <div class="value" id="modalPurchases">0</div>
                    <div class="label">ğŸ“¦ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                </div>
                <div class="modal-stat">
                    <div class="value" id="modalTotalSpent">0</div>
                    <div class="label">ğŸ’³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚</div>
                </div>
            </div>
            
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ -->
            <div id="phoneInfo" style="margin-bottom: 20px;"></div>
            
            <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('charges')">ğŸ’³ Ø§Ù„Ø´Ø­Ù†Ø§Øª</button>
                    <button class="tab-btn" onclick="switchTab('purchases')">ğŸ“¦ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
                    <button class="tab-btn" onclick="switchTab('invoices')">ğŸ§¾ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
                </div>
            </div>
            
            <div id="chargesTab" class="tab-content active"></div>
            <div id="purchasesTab" class="tab-content"></div>
            <div id="invoicesTab" class="tab-content"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
let allCustomers = [];
let revenueChart = null;
let customersChart = null;

async function loadDashboard() {
    try {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const statsRes = await fetch('/api/admin/advanced_stats');
        const statsData = await statsRes.json();
        
        if (statsData.status === 'success') {
            const s = statsData.stats;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            document.getElementById('totalCustomers').textContent = s.total_customers || 0;
            document.getElementById('verifiedPhones').textContent = s.verified_phones || 0;
            document.getElementById('totalInvoices').textContent = s.total_invoices || 0;
            document.getElementById('totalRevenue').textContent = (s.total_revenue || 0).toFixed(0);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
            updateCharts(s);
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        const customersRes = await fetch('/api/admin/get_customers_advanced');
        const customersData = await customersRes.json();
        
        if (customersData.status === 'success') {
            allCustomers = customersData.customers;
            renderCustomers();
        }
        
    } catch (e) {
        console.error('Error loading dashboard:', e);
        showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

function updateCharts(stats) {
    // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueChart) revenueChart.destroy();
    
    const days = ['Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©'];
    const revenueData = stats.weekly_revenue || [0, 0, 0, 0, 0, 0, 0];
    
    revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: days,
            datasets: [{
                label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø±.Ø³)',
                data: revenueData,
                borderColor: '#6c5ce7',
                backgroundColor: 'rgba(108, 92, 231, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#6c5ce7',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#b2bec3' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#b2bec3' }
                }
            }
        }
    });
    
    // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    const customersCtx = document.getElementById('customersChart');
    if (customersChart) customersChart.destroy();
    
    customersChart = new Chart(customersCtx, {
        type: 'doughnut',
        data: {
            labels: ['Ù…ÙˆØ«Ù‚ÙŠÙ†', 'ØºÙŠØ± Ù…ÙˆØ«Ù‚ÙŠÙ†', 'Ù†Ø´Ø·ÙŠÙ†'],
            datasets: [{
                data: [
                    stats.verified_phones || 0,
                    (stats.total_customers || 0) - (stats.verified_phones || 0),
                    stats.active_customers || 0
                ],
                backgroundColor: ['#00b894', '#636e72', '#6c5ce7'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#b2bec3', padding: 15 }
                }
            }
        }
    });
}

function renderCustomers() {
    const container = document.getElementById('customersList');
    const search = document.getElementById('searchCustomers').value.toLowerCase();
    
    let filtered = allCustomers.filter(c => {
        const name = (c.name || '').toLowerCase();
        const phone = (c.verified_phone || '').toLowerCase();
        const id = (c.user_id || '').toString();
        return name.includes(search) || phone.includes(search) || id.includes(search);
    });
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="icon">ğŸ“­</div>
                <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filtered.slice(0, 50).map((c, i) => {
        const name = c.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
        const phone = c.verified_phone || '';
        const hasPhone = phone && phone.length > 0;
        
        return `
            <div class="customer-row">
                <div>${i + 1}</div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="customer-avatar">${name.charAt(0)}</div>
                    <div class="customer-info">
                        <h4>${name}</h4>
                        <p>#${c.user_id || '-'}</p>
                    </div>
                </div>
                <div class="customer-phone ${hasPhone ? '' : 'no-phone'}">
                    ${hasPhone ? phone : 'ØºÙŠØ± Ù…ÙˆØ«Ù‚'}
                </div>
                <div style="font-weight: 600; color: var(--success);">
                    ${(c.balance || 0).toFixed(2)} Ø±.Ø³
                </div>
                <div>
                    <span class="badge badge-primary">${c.invoices_count || 0}</span>
                </div>
                <div style="font-size: 12px; color: var(--muted);">
                    ${formatDate(c.last_activity)}
                </div>
                <div>
                    <button class="action-btn view" onclick="viewCustomer('${c.user_id}')">
                        ğŸ‘ï¸ Ø¹Ø±Ø¶
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function filterCustomers(type) {
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    const container = document.getElementById('customersList');
    let filtered = allCustomers;
    
    if (type === 'verified') {
        filtered = allCustomers.filter(c => c.verified_phone && c.verified_phone.length > 0);
    } else if (type === 'active') {
        filtered = allCustomers.filter(c => (c.balance || 0) > 0 || (c.invoices_count || 0) > 0);
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±
    const search = document.getElementById('searchCustomers').value.toLowerCase();
    filtered = filtered.filter(c => {
        const name = (c.name || '').toLowerCase();
        const phone = (c.verified_phone || '').toLowerCase();
        const id = (c.user_id || '').toString();
        return name.includes(search) || phone.includes(search) || id.includes(search);
    });
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="icon">ğŸ“­</div>
                <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filtered.slice(0, 50).map((c, i) => {
        const name = c.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
        const phone = c.verified_phone || '';
        const hasPhone = phone && phone.length > 0;
        
        return `
            <div class="customer-row">
                <div>${i + 1}</div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="customer-avatar">${name.charAt(0)}</div>
                    <div class="customer-info">
                        <h4>${name}</h4>
                        <p>#${c.user_id || '-'}</p>
                    </div>
                </div>
                <div class="customer-phone ${hasPhone ? '' : 'no-phone'}">
                    ${hasPhone ? phone : 'ØºÙŠØ± Ù…ÙˆØ«Ù‚'}
                </div>
                <div style="font-weight: 600; color: var(--success);">
                    ${(c.balance || 0).toFixed(2)} Ø±.Ø³
                </div>
                <div>
                    <span class="badge badge-primary">${c.invoices_count || 0}</span>
                </div>
                <div style="font-size: 12px; color: var(--muted);">
                    ${formatDate(c.last_activity)}
                </div>
                <div>
                    <button class="action-btn view" onclick="viewCustomer('${c.user_id}')">
                        ğŸ‘ï¸ Ø¹Ø±Ø¶
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

async function viewCustomer(userId) {
    const modal = document.getElementById('customerModal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    try {
        const res = await fetch(`/api/admin/get_customer_full?user_id=${userId}`);
        const data = await res.json();
        
        if (data.status === 'success') {
            const c = data.customer;
            const name = c.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
            
            document.getElementById('modalAvatar').textContent = name.charAt(0);
            document.getElementById('modalName').textContent = name;
            document.getElementById('modalId').textContent = `ID: ${userId}`;
            document.getElementById('modalBalance').textContent = (c.balance || 0).toFixed(2);
            document.getElementById('modalInvoices').textContent = c.invoices_count || 0;
            document.getElementById('modalPurchases').textContent = c.purchases_count || 0;
            document.getElementById('modalTotalSpent').textContent = (c.total_spent || 0).toFixed(0);
            
            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„
            const phoneInfo = document.getElementById('phoneInfo');
            if (c.verified_phone) {
                phoneInfo.innerHTML = `
                    <div style="background: rgba(0,184,148,0.1); border: 1px solid rgba(0,184,148,0.3); border-radius: 15px; padding: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <span style="color: var(--success); font-size: 20px;">ğŸ“±</span>
                            <span style="font-size: 18px; font-weight: 600; margin-right: 10px; direction: ltr;">${c.verified_phone}</span>
                            <span class="badge badge-success">Ù…ÙˆØ«Ù‚ âœ“</span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-warning btn-sm" onclick="changePhone('${userId}')">âœï¸ ØªØºÙŠÙŠØ±</button>
                            <button class="btn btn-danger btn-sm" onclick="deletePhone('${userId}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </div>
                    </div>
                `;
            } else {
                phoneInfo.innerHTML = `
                    <div style="background: rgba(108,117,125,0.1); border: 1px solid rgba(108,117,125,0.3); border-radius: 15px; padding: 20px;">
                        <span style="color: var(--muted);">ğŸ“± Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù…ÙˆØ«Ù‚</span>
                    </div>
                `;
            }
            
            // Ø§Ù„Ø´Ø­Ù†Ø§Øª
            renderCharges(c.charges || []);
            
            // Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            renderPurchases(c.purchases || []);
            
            // Ø§Ù„ÙÙˆØ§ØªÙŠØ±
            renderInvoices(c.invoices || []);
        }
    } catch (e) {
        console.error('Error:', e);
        showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„', 'error');
    }
}

function renderCharges(charges) {
    const container = document.getElementById('chargesTab');
    if (!charges.length) {
        container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ’³</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø­Ù†Ø§Øª</p></div>';
        return;
    }
    
    container.innerHTML = charges.map(c => {
        const methodIcon = {'key': 'ğŸ”‘', 'admin': 'ğŸ‘‘', 'edfapay': 'ğŸ’³', 'card': 'ğŸ’³'}[c.method] || 'ğŸ’³';
        return `
            <div class="history-item">
                <div class="info">
                    <div class="icon-box charge">${methodIcon}</div>
                    <div>
                        <strong>+${c.amount} Ø±.Ø³</strong>
                        <p style="margin: 0; font-size: 12px; color: var(--muted);">${formatDate(c.created_at)}</p>
                    </div>
                </div>
                <span class="badge badge-success">Ù…ÙƒØªÙ…Ù„</span>
            </div>
        `;
    }).join('');
}

function renderPurchases(purchases) {
    const container = document.getElementById('purchasesTab');
    if (!purchases.length) {
        container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“¦</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª</p></div>';
        return;
    }
    
    container.innerHTML = purchases.map(p => `
        <div class="history-item">
            <div class="info">
                <div class="icon-box purchase">ğŸ“¦</div>
                <div>
                    <strong>${p.product_name || 'Ù…Ù†ØªØ¬'}</strong>
                    <p style="margin: 0; font-size: 12px; color: var(--muted);">${formatDate(p.created_at)}</p>
                </div>
            </div>
            <span style="font-weight: 600; color: var(--danger);">-${p.price || 0} Ø±.Ø³</span>
        </div>
    `).join('');
}

function renderInvoices(invoices) {
    const container = document.getElementById('invoicesTab');
    if (!invoices.length) {
        container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ§¾</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±</p></div>';
        return;
    }
    
    container.innerHTML = invoices.map(inv => {
        const statusBadge = inv.status === 'paid' 
            ? '<span class="badge badge-success">Ù…Ø¯ÙÙˆØ¹Ø©</span>'
            : '<span class="badge badge-warning">Ù…Ø¹Ù„Ù‚Ø©</span>';
        return `
            <div class="history-item">
                <div class="info">
                    <div class="icon-box invoice">ğŸ§¾</div>
                    <div>
                        <strong>${inv.amount || 0} Ø±.Ø³</strong>
                        <p style="margin: 0; font-size: 12px; color: var(--muted);">${formatDate(inv.created_at)}</p>
                    </div>
                </div>
                ${statusBadge}
            </div>
        `;
    }).join('');
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName + 'Tab').classList.add('active');
}

function closeCustomerModal() {
    document.getElementById('customerModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    try {
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr;
        return d.toLocaleString('en-GB', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit',
            timeZone: 'Asia/Riyadh'
        }).replace(',', ' -');
    } catch {
        return dateStr;
    }
}

function exportData() {
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªØµØ¯ÙŠØ±...', 'info');
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªØµØ¯ÙŠØ± Excel Ù‡Ù†Ø§
}

async function changePhone(userId) {
    const newPhone = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05):');
    if (!newPhone) return;
    
    if (!newPhone.startsWith('05') || newPhone.length !== 10) {
        showToast('Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­!', 'error');
        return;
    }
    
    try {
        const res = await fetch('/api/admin/reset_phone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, action: 'change', new_phone: newPhone })
        });
        const data = await res.json();
        if (data.status === 'success') {
            showToast('âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù…');
            closeCustomerModal();
            loadDashboard();
        } else {
            showToast(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
        }
    } catch (e) {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
    }
}

async function deletePhone(userId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ØŸ')) return;
    
    try {
        const res = await fetch('/api/admin/reset_phone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, action: 'delete' })
        });
        const data = await res.json();
        if (data.status === 'success') {
            showToast('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ù‚Ù…');
            closeCustomerModal();
            loadDashboard();
        } else {
            showToast(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
        }
    } catch (e) {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
    }
}

// Ø§Ù„Ø¨Ø­Ø«
document.getElementById('searchCustomers').addEventListener('input', renderCustomers);

// ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}
